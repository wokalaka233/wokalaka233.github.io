<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Toolbox</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            overflow-x: hidden;
        }

        /* 导航栏样式 + 动画 */
        .navbar {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 240px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
            padding: 30px 0;
            display: flex;
            flex-direction: column;
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .navbar-logo {
            text-align: center;
            margin-bottom: 50px;
            padding: 0 20px;
            animation: fadeInDown 1s ease;
        }

        .navbar-logo h2 {
            font-size: 24px;
            color: #667eea;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .navbar-logo p {
            color: #777;
            font-size: 14px;
        }

        .nav-list {
            list-style: none;
            flex: 1;
        }

        .nav-item {
            margin: 15px 0;
            opacity: 0;
            animation: fadeInLeft 0.5s ease forwards;
        }

        .nav-item:nth-child(1) { animation-delay: 0.2s; }
        .nav-item:nth-child(2) { animation-delay: 0.4s; }
        .nav-item:nth-child(3) { animation-delay: 0.6s; }
        .nav-item:nth-child(4) { animation-delay: 0.8s; }

        .nav-link {
            display: block;
            padding: 12px 30px;
            color: #555;
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
            position: relative;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            left: 30px;
            bottom: 0;
            width: 0;
            height: 2px;
            background: #667eea;
            transition: width 0.3s ease;
        }

        .nav-link:hover, .nav-link.active {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding-left: 35px;
        }

        .nav-link:hover::after, .nav-link.active::after {
            width: 40%;
        }

        /* 主内容区样式 */
        .main-content {
            margin-left: 240px;
            padding: 50px;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: fadeIn 1s ease;
        }

        .section {
            background: rgba(255, 255, 255, 0.95);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.15);
            width: 100%;
            max-width: 800px;
            display: none;
            animation: slideUp 0.6s ease forwards;
            transform: translateY(30px);
            opacity: 0;
        }

        .section.active {
            display: block;
        }

        /* 动画定义（初代风格：简洁平滑） */
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes fadeInDown {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInLeft {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.03); }
            100% { transform: scale(1); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }

        /* 自我介绍板块 */
        .intro-header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }

        .intro-header h2 {
            font-size: 32px;
            color: #333;
            margin-bottom: 10px;
            position: relative;
            display: inline-block;
        }

        .intro-header h2::after {
            content: '';
            display: block;
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 2px;
            margin: 10px auto 0;
            animation: grow 1.2s ease;
        }

        @keyframes grow {
            from { width: 0; }
            to { width: 80px; }
        }

        .intro-content {
            line-height: 1.8;
            font-size: 16px;
            color: #555;
            animation: fadeIn 1s ease 0.3s forwards;
            opacity: 0;
        }

        .intro-content p {
            margin-bottom: 20px;
        }

        .intro-highlights {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 30px;
            animation: fadeIn 1s ease 0.6s forwards;
            opacity: 0;
        }

        .highlight-card {
            flex: 1;
            min-width: 200px;
            padding: 20px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 12px;
            border: 1px solid #eee;
            transition: all 0.3s ease;
        }

        .highlight-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.08);
            animation: pulse 0.6s ease;
        }

        .highlight-card h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .highlight-card p {
            font-size: 14px;
            color: #666;
            margin-bottom: 0;
        }

        /* BMI计算器样式 + 动画 */
        .bmi-header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }

        .bmi-header h2 {
            font-size: 28px;
            color: #333;
        }

        .bmi-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            animation: fadeIn 1s ease 0.3s forwards;
            opacity: 0;
        }

        .input-box {
            margin: 15px 0;
            transition: all 0.3s ease;
        }

        .input-box label {
            display: block;
            margin-bottom: 8px;
            color: #555;
            font-weight: 500;
        }

        .bmi-container input {
            padding: 8px;
            width: 200px;
            font-size: 16px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            transition: all 0.3s ease;
            outline: none;
        }

        .bmi-container input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
            transform: translateX(5px);
        }

        .bmi-container button {
            padding: 10px 20px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .bmi-container button:hover {
            background-color: #45a049;
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(72, 187, 120, 0.2);
        }

        #bmi-result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 5px;
            font-size: 18px;
            transition: all 0.3s ease;
            opacity: 0;
        }

        #bmi-result.show {
            opacity: 1;
            transform: translateY(0);
            animation: slideUp 0.5s ease;
        }

        /* 俄罗斯方块板块样式（手机端适配+网格线+动画） */
        .tetris-header {
            text-align: center;
            margin-bottom: 20px;
            animation: fadeInDown 0.8s ease;
        }

        .tetris-header h2 {
            font-size: 28px;
            color: #333;
        }

        .tetris-container {
            display: flex;
            justify-content: center;
            align-items: flex-start;
            gap: 30px;
            flex-wrap: wrap;
            width: 100%;
            margin-bottom: 20px;
            animation: fadeIn 1s ease 0.3s forwards;
            opacity: 0;
        }

        .tetris-main {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        #tetris-board {
            border: 3px solid #667eea;
            border-radius: 8px;
            background: #f8f9fa;
            max-width: 90vw;
            height: auto;
            aspect-ratio: 300/600;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.15);
            transition: all 0.3s ease;
        }

        #tetris-board:hover {
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.2);
        }

        .tetris-sidebar-pc {
            display: flex;
            flex-direction: column;
            gap: 20px;
            min-width: 180px;
        }

        .tetris-info {
            padding: 15px;
            background: rgba(102, 126, 234, 0.05);
            border-radius: 8px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .tetris-info:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
        }

        .tetris-info h3 {
            color: #667eea;
            margin-bottom: 10px;
            font-size: 16px;
        }

        .tetris-info p {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            transition: all 0.3s ease;
        }

        .tetris-info p.update {
            animation: shake 0.3s ease;
        }

        .tetris-controls-pc {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .tetris-btn-pc {
            padding: 10px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .tetris-btn-pc:hover {
            opacity: 0.9;
            transform: scale(1.03);
            box-shadow: 0 3px 8px rgba(102, 126, 234, 0.2);
        }

        .tetris-btn-pc:active {
            transform: scale(0.98);
        }

        .controls-tip {
            margin-top: 10px;
            font-size: 13px;
            color: #666;
            text-align: center;
        }

        /* 手机端专属样式 */
        .tetris-info-mobile {
            display: none;
            flex-direction: row;
            gap: 20px;
            margin-top: 15px;
            width: 100%;
            justify-content: center;
        }

        .tetris-controls-mobile {
            display: none;
            margin-top: 20px;
            width: 100%;
            animation: fadeIn 1s ease 0.6s forwards;
            opacity: 0;
        }

        .control-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .tetris-btn-mobile {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(102, 126, 234, 0.2);
        }

        .tetris-btn-mobile:hover {
            transform: scale(1.08);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .tetris-btn-mobile:active {
            transform: scale(0.95);
        }

        /* 音乐下载板块样式 + 动画 */
        .music-header {
            text-align: center;
            margin-bottom: 30px;
            animation: fadeInDown 0.8s ease;
        }

        .music-header h2 {
            font-size: 28px;
            color: #333;
        }

        .music-container {
            font-family: Arial, Helvetica, sans-serif;
            margin: 40px;
            text-align: center;
            animation: fadeIn 1s ease 0.3s forwards;
            opacity: 0;
        }

        .music-container button {
            margin: 10px;
            padding: 8px 18px;
            font-size: 16px;
            background: linear-gradient(90deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .music-container button:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.2);
        }

        .music-container audio {
            width: 80%;
            margin-top: 20px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .music-container audio:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }

        /* 响应式适配 */
        @media (max-width: 768px) {
            .navbar {
                width: 100%;
                height: auto;
                flex-direction: row;
                padding: 15px 20px;
            }

            .navbar-logo {
                margin-bottom: 0;
                margin-right: auto;
            }

            .navbar-logo h2 {
                font-size: 20px;
            }

            .nav-list {
                display: flex;
                flex-direction: row;
                align-items: center;
                gap: 10px;
            }

            .nav-item {
                margin: 0;
            }

            .nav-link {
                padding: 8px 15px;
                font-size: 14px;
            }

            .nav-link:hover, .nav-link.active {
                padding-left: 15px;
            }

            .main-content {
                margin-left: 0;
                margin-top: 80px;
                padding: 20px;
            }

            .section {
                padding: 25px;
            }

            .tetris-container {
                flex-direction: column;
                align-items: center;
                gap: 15px;
            }

            .tetris-sidebar-pc {
                display: none;
            }

            .tetris-info-mobile {
                display: flex;
            }

            .tetris-controls-mobile {
                display: block;
            }
        }

        @media (min-width: 769px) {
            .tetris-info-mobile,
            .tetris-controls-mobile {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- 侧边导航栏 -->
    <nav class="navbar">
        <div class="navbar-logo">
            <h2>wpf的工具箱</h2>
            <p>小小工具</p>
        </div>
        <ul class="nav-list">
            <li class="nav-item">
                <a href="#intro" class="nav-link active" onclick="switchSection('intro')">关于我</a>
            </li>
            <li class="nav-item">
                <a href="#bmi" class="nav-link" onclick="switchSection('bmi')">BMI计算器</a>
            </li>
            <li class="nav-item">
                <a href="#tetris" class="nav-link" onclick="switchSection('tetris')">俄罗斯方块</a>
            </li>
            <li class="nav-item">
                <a href="#music" class="nav-link" onclick="switchSection('music')">音乐下载+播放</a>
            </li>
        </ul>
    </nav>

    <!-- 主内容区 -->
    <div class="main-content">
        <!-- 自我介绍板块 -->
        <section id="intro" class="section active">
            <div class="intro-header">
                <h2>关于这个网站</h2>
            </div>
            <div class="intro-content">
                <p>大家好我是wpf！这是一个有许多小工具的网站，目前包含三个核心板块：</p>
                <p>1. 这里是wokalaka的小工具箱 ！（后续功能敬请期待）；</p>
                <p>2. BMI计算器：计算并反馈详细BMI状态；</p>
                <p>3. 俄罗斯方块：经典怀旧游戏，支持键盘操作，目前已适配手机；</p>
                <p>4. 音乐下载+播放：提供在线音乐播放和本地下载功能，支持主流格式（目前因版权问题不能使用 等我努力 sorry~）</p>
                <p>网站采用简洁美观的设计风格，适配电脑和手机等多种设备，希望能给你带来便捷又有趣的使用体验～</p>
            </div>
            <div class="intro-highlights">
                <div class="highlight-card">
                    <h3>个性化BMI工具</h3>
                    <p>国际通用的衡量人体胖瘦程度与健康状况的标准。快来测一测吧！</p>
                </div>
                <div class="highlight-card">
                    <h3>趣味游戏</h3>
                    <p>经典俄罗斯方块，电脑可使用键盘操作！</p>
                </div>
                <div class="highlight-card">
                    <h3>音乐娱乐</h3>
                    <p>在线播放+本地下载，满足音乐聆听需求</p>
                </div>
            </div>
        </section>

        <!-- BMI计算器（带姓名版，已修正18.50-18.60判定） -->
        <section id="bmi" class="section">
            <div class="bmi-header">
                <h2>BMI计算器</h2>
            </div>
            <div class="bmi-container">
                <h1>欢迎使用BMI计算器</h1>
                <div class="input-box">
                    <label>请输入你的名字：</label><br>
                    <input type="text" id="name" placeholder="例如：雨淳">
                </div>
                <div class="input-box">
                    <label>请输入你的体重(kg)：</label><br>
                    <input type="number" id="weight" step="0.1" placeholder="例如：90">
                </div>
                <div class="input-box">
                    <label>请输入你的身高(m)：</label><br>
                    <input type="number" id="height" step="0.01" placeholder="例如：1.75 单位是m">
                </div>
                <button onclick="calculateBMI()">计算BMI</button>
                <div id="bmi-result"></div>
            </div>
        </section>

        <!-- 俄罗斯方块板块（手机端适配+网格线） -->
        <section id="tetris" class="section">
            <div class="tetris-header">
                <h2>经典俄罗斯方块</h2>
            </div>
            <div class="tetris-container">
                <div class="tetris-main">
                    <canvas id="tetris-board" width="300" height="600"></canvas>
                    <div class="tetris-info-mobile">
                        <div class="tetris-info">
                            <h3>分数</h3>
                            <p id="score-mobile">0</p>
                        </div>
                        <div class="tetris-info">
                            <h3>等级</h3>
                            <p id="level-mobile">1</p>
                        </div>
                    </div>
                </div>
                <div class="tetris-sidebar-pc">
                    <div class="tetris-info">
                        <h3>分数</h3>
                        <p id="score-pc">0</p>
                    </div>
                    <div class="tetris-info">
                        <h3>等级</h3>
                        <p id="level-pc">1</p>
                    </div>
                    <div class="tetris-controls-pc">
                        <button class="tetris-btn-pc" onclick="moveLeft()">← 左移</button>
                        <button class="tetris-btn-pc" onclick="moveRight()">→ 右移</button>
                        <button class="tetris-btn-pc" onclick="rotate()">↑ 旋转</button>
                        <button class="tetris-btn-pc" onclick="moveDown()">↓ 下移</button>
                        <button class="tetris-btn-pc" onclick="startGame()">开始游戏</button>
                        <button class="tetris-btn-pc" onclick="pauseGame()">暂停/继续</button>
                    </div>
                    <div class="controls-tip">
                        支持键盘操作：↑旋转 ←→移动 ↓下移 空格快速下落
                    </div>
                </div>
            </div>
            <div class="tetris-controls-mobile">
                <div class="control-row">
                    <button class="tetris-btn-mobile" onclick="moveLeft()">←</button>
                    <button class="tetris-btn-mobile" onclick="rotate()">↑</button>
                    <button class="tetris-btn-mobile" onclick="moveRight()">→</button>
                </div>
                <div class="control-row">
                    <button class="tetris-btn-mobile" onclick="startGame()">开始</button>
                    <button class="tetris-btn-mobile" onclick="moveDown()">↓</button>
                    <button class="tetris-btn-mobile" onclick="pauseGame()">暂停</button>
                </div>
            </div>
        </section>

        <!-- 音乐下载板块 -->
        <section id="music" class="section">
            <div class="music-header">
                <h2>音乐下载+在线播放</h2>
            </div>
            <div class="music-container">
                <h2>1. 点“下载音乐”会把文件落到本地</h2>
                <button id="btnDl">下载音乐</button>
                <h2>2. 在线播放（支持换源）</h2>
                <audio id="player" controls></audio>
            </div>
        </section>
    </div>

    <script>
        // 1. 板块切换功能
        function switchSection(sectionId) {
            document.querySelectorAll('.section').forEach(section => {
                section.classList.remove('active');
            });
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            const targetSection = document.getElementById(sectionId);
            targetSection.classList.add('active');
            document.querySelector(`.nav-link[href="#${sectionId}"]`).classList.add('active');
            
            // 板块切换动画重置
            targetSection.style.opacity = '0';
            targetSection.style.transform = 'translateY(30px)';
            setTimeout(() => {
                targetSection.style.opacity = '1';
                targetSection.style.transform = 'translateY(0)';
            }, 50);
        }

        // 2. BMI计算器（带姓名版，修正18.50-18.60判定）
        function calculateBMI() {
            const name = document.getElementById("name").value;
            const weight = parseFloat(document.getElementById("weight").value);
            const height = parseFloat(document.getElementById("height").value);
            const resultEl = document.getElementById("bmi-result");
            
            // 输入验证
            if (!name || isNaN(weight) || isNaN(height) || height <= 0 || weight <= 0) {
                resultEl.textContent = "请输入正确的信息哦！";
                resultEl.className = "show";
                resultEl.style.background = "rgba(239, 68, 68, 0.1)";
                resultEl.style.color = "#ef4444";
                return;
            }
            
            // 计算BMI
            const bmi = weight / (height ** 2);
            const bmiRounded = bmi.toFixed(2);
            let status, bgColor, textColor;
            
            // 修正判定逻辑：18.5（含）以下过轻，18.5-25（含）正常（覆盖18.50-18.60）
            if (bmi < 18.5) {
                status = "您属于过轻";
                bgColor = "rgba(102, 126, 234, 0.1)";
                textColor = "#667eea";
            } else if (bmi >= 18.5 && bmi <= 25) {
                status = "您属于正常";
                bgColor = "rgba(72, 187, 120, 0.1)";
                textColor = "#48bb78";
            } else if (bmi > 25 && bmi < 28) {
                status = "您属于过重";
                bgColor = "rgba(246, 190, 0, 0.1)";
                textColor = "#f6be00";
            } else if (bmi >= 28 && bmi < 32) {
                status = "您属于肥胖";
                bgColor = "rgba(239, 68, 68, 0.1)";
                textColor = "#ef4444";
            } else {
                status = "您属于严重肥胖";
                bgColor = "rgba(220, 38, 38, 0.1)";
                textColor = "#dc2626";
            }
            
            // 显示结果（带动画）
            resultEl.textContent = `Hello ${name}！你的BMI是 ${bmiRounded}，${status}`;
            resultEl.style.background = bgColor;
            resultEl.style.color = textColor;
            resultEl.classList.add("show");
        }

        // 3. 音乐下载+播放逻辑
        const AUDIO_URL = 'https://www.soundhelix.com/examples/mp3/SoundHelix-Song-1.mp3';
        document.getElementById('btnDl').addEventListener('click', async () => {
            const a = document.createElement('a');
            a.href = AUDIO_URL;
            a.download = 'mysong.mp3';
            a.click();
            
            // 下载按钮动画
            const btn = document.getElementById('btnDl');
            btn.textContent = "下载中...";
            setTimeout(() => {
                btn.textContent = "下载音乐";
            }, 1500);
        });
        document.getElementById('player').src = AUDIO_URL;

        // 4. 俄罗斯方块核心逻辑（手机端适配+网格线+动画）
        const canvas = document.getElementById('tetris-board');
        const ctx = canvas.getContext('2d');
        const gridSize = 30;
        const rows = canvas.height / gridSize;
        const cols = canvas.width / gridSize;
        let board = [];
        let currentPiece = null;
        let score = 0;
        let level = 1;
        let linesCleared = 0;
        let gameInterval;
        let isPaused = false;

        // 方块形状定义
        const shapes = [
            [[1, 1, 1, 1]], // I型
            [[1, 1], [1, 1]], // O型
            [[1, 1, 1], [0, 1, 0]], // T型
            [[1, 1, 1], [1, 0, 0]], // L型
            [[1, 1, 1], [0, 0, 1]], // J型
            [[1, 1, 0], [0, 1, 1]], // S型
            [[0, 1, 1], [1, 1, 0]]  // Z型
        ];

        // 方块颜色
        const colors = [
            '#00f0f0', '#f0f000', '#a000f0', '#f0a000',
            '#0000f0', '#00f000', '#f00000'
        ];

        // 初始化游戏面板
        function initBoard() {
            board = Array(rows).fill().map(() => Array(cols).fill(0));
        }

        // 随机生成方块
        function generatePiece() {
            const shapeIndex = Math.floor(Math.random() * shapes.length);
            const shape = shapes[shapeIndex];
            const color = colors[shapeIndex];
            const x = Math.floor(cols / 2) - Math.floor(shape[0].length / 2);
            const y = 0;
            return { shape, color, x, y };
        }

        // 绘制网格线（便于对齐）
        function drawGrid() {
            ctx.strokeStyle = '#e0e0e0'; // 浅灰色，不遮挡方块
            ctx.lineWidth = 0.5; // 细线条，不突兀
            // 竖线
            for (let x = 0; x <= canvas.width; x += gridSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            // 横线
            for (let y = 0; y <= canvas.height; y += gridSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }

        // 绘制游戏面板
        function drawBoard() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            drawGrid(); // 先画网格线
            // 绘制已锁定的方块
            board.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell) {
                        drawCell(x, y, cell);
                    }
                });
            });
        }

        // 绘制单个方块（带边框高亮）
        function drawCell(x, y, color) {
            ctx.fillStyle = color;
            ctx.fillRect(x * gridSize, y * gridSize, gridSize - 1, gridSize - 1);
            ctx.strokeStyle = '#fff';
            ctx.strokeRect(x * gridSize, y * gridSize, gridSize - 1, gridSize - 1);
            
            // 方块hover高亮（可选）
            if (currentPiece && x >= currentPiece.x && x < currentPiece.x + currentPiece.shape[0].length &&
                y >= currentPiece.y && y < currentPiece.y + currentPiece.shape.length) {
                ctx.fillStyle = `${color}80`; // 半透明叠加
                ctx.fillRect(x * gridSize, y * gridSize, gridSize - 1, gridSize - 1);
            }
        }

        // 绘制当前下落方块
        function drawPiece() {
            if (!currentPiece) return;
            currentPiece.shape.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell) {
                        const drawX = currentPiece.x + x;
                        const drawY = currentPiece.y + y;
                        if (drawY >= 0) {
                            drawCell(drawX, drawY, currentPiece.color);
                        }
                    }
                });
            });
        }

        // 碰撞检测
        function checkCollision(piece, offsetX = 0, offsetY = 0) {
            for (let y = 0; y < piece.shape.length; y++) {
                for (let x = 0; x < piece.shape[y].length; x++) {
                    if (piece.shape[y][x]) {
                        const newX = piece.x + x + offsetX;
                        const newY = piece.y + y + offsetY;
                        if (
                            newX < 0 || newX >= cols ||
                            newY >= rows ||
                            (newY >= 0 && board[newY][newX])
                        ) {
                            return true;
                        }
                    }
                }
            }
            return false;
        }

        // 旋转方块（带动画感）
        function rotatePiece() {
            if (isPaused || !currentPiece) return;
            const rotatedShape = currentPiece.shape[0].map((_, index) =>
                currentPiece.shape.map(row => row[index]).reverse()
            );
            const newPiece = { ...currentPiece, shape: rotatedShape };
            if (!checkCollision(newPiece)) {
                // 旋转动画：轻微缩放
                ctx.save();
                ctx.scale(1.1, 1.1);
                currentPiece = newPiece;
                ctx.restore();
            }
        }

        // 锁定方块到面板
        function lockPiece() {
            currentPiece.shape.forEach((row, y) => {
                row.forEach((cell, x) => {
                    if (cell) {
                        const newY = currentPiece.y + y;
                        if (newY >= 0) {
                            board[newY][currentPiece.x + x] = currentPiece.color;
                        }
                    }
                });
            });
            clearLines();
            currentPiece = generatePiece();
            // 新方块生成动画
            if (currentPiece) {
                ctx.save();
                ctx.globalAlpha = 0.5;
                drawPiece();
                ctx.restore();
                setTimeout(() => {
                    ctx.globalAlpha = 1;
                }, 100);
            }
            if (checkCollision(currentPiece)) {
                gameOver();
            }
        }

        // 消除完整行（带动画）
        function clearLines() {
            let lines = 0;
            const linesToClear = [];
            board.forEach((row, y) => {
                if (!row.includes(0)) {
                    lines++;
                    linesToClear.push(y);
                }
            });
            
            // 消除动画
            if (lines > 0) {
                linesToClear.forEach(y => {
                    board[y] = Array(cols).fill('#ff000033'); // 红色闪烁
                });
                drawBoard();
                drawPiece();
                
                setTimeout(() => {
                    // 真正消除行
                    board = board.filter(row => row.includes(0));
                    while (board.length < rows) {
                        board.unshift(Array(cols).fill(0));
                    }
                    
                    // 更新分数和等级
                    linesCleared += lines;
                    score += lines * 100 * level;
                    if (linesCleared >= level * 10) {
                        level++;
                        clearInterval(gameInterval);
                        gameInterval = setInterval(gameLoop, 1000 / level);
                        // 升级提示动画
                        const levelEls = [document.getElementById('level-mobile'), document.getElementById('level-pc')];
                        levelEls.forEach(el => {
                            el.classList.add('update');
                            setTimeout(() => el.classList.remove('update'), 500);
                        });
                    }
                    
                    // 分数更新动画
                    const scoreEls = [document.getElementById('score-mobile'), document.getElementById('score-pc')];
                    scoreEls.forEach(el => {
                        el.textContent = score;
                        el.classList.add('update');
                        setTimeout(() => el.classList.remove('update'), 500);
                    });
                    document.getElementById('level-mobile').textContent = level;
                    document.getElementById('level-pc').textContent = level;
                }, 200);
            }
        }

        // 游戏结束
        function gameOver() {
            clearInterval(gameInterval);
            // 游戏结束动画
            ctx.save();
            ctx.fillStyle = 'rgba(0,0,0,0.5)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.restore();
            setTimeout(() => {
                alert(`游戏结束！你的分数：${score}，等级：${level}`);
                initGame();
            }, 500);
        }

        // 游戏循环
        function gameLoop() {
            if (isPaused) return;
            currentPiece.y++;
            if (checkCollision(currentPiece)) {
                currentPiece.y--;
                lockPiece();
            }
            drawBoard();
            drawPiece();
        }

        // 方块控制函数
        function moveLeft() {
            if (isPaused || !currentPiece) return;
            if (!checkCollision(currentPiece, -1, 0)) {
                currentPiece.x--;
                drawBoard();
                drawPiece();
            }
        }

        function moveRight() {
            if (isPaused || !currentPiece) return;
            if (!checkCollision(currentPiece, 1, 0)) {
                currentPiece.x++;
                drawBoard();
                drawPiece();
            }
        }

        function moveDown() {
            if (isPaused || !currentPiece) return;
            currentPiece.y++;
            if (checkCollision(currentPiece)) {
                currentPiece.y--;
                lockPiece();
            }
            drawBoard();
            drawPiece();
        }

        function rotate() {
            rotatePiece();
            drawBoard();
            drawPiece();
        }

        // 开始游戏
        function startGame() {
            if (gameInterval) clearInterval(gameInterval);
            initBoard();
            currentPiece = generatePiece();
            score = 0;
            level = 1;
            linesCleared = 0;
            isPaused = false;
            // 初始化分数显示
            document.getElementById('score-mobile').textContent = score;
            document.getElementById('score-pc').textContent = score;
            document.getElementById('level-mobile').textContent = level;
            document.getElementById('level-pc').textContent = level;
            // 游戏开始动画
            ctx.fillStyle = 'rgba(255,255,255,0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            setTimeout(() => {
                gameInterval = setInterval(gameLoop, 1000);
                drawBoard();
                drawPiece();
            }, 300);
        }

        // 暂停/继续游戏
        function pauseGame() {
            isPaused = !isPaused;
            if (isPaused) {
                // 暂停遮罩
                ctx.fillStyle = 'rgba(0,0,0,0.3)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = 'white';
                ctx.font = '24px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('暂停中', canvas.width/2, canvas.height/2);
            } else {
                drawBoard();
                drawPiece();
            }
        }

        // 键盘控制
        document.addEventListener('keydown', (e) => {
            if (!currentPiece) return;
            switch (e.key) {
                case 'ArrowLeft': moveLeft(); break;
                case 'ArrowRight': moveRight(); break;
                case 'ArrowDown': moveDown(); break;
                case 'ArrowUp': rotate(); break;
                case ' ': // 空格快速下落
                    while (!checkCollision(currentPiece, 0, 1)) {
                        currentPiece.y++;
                    }
                    lockPiece();
                    drawBoard();
                    drawPiece();
                    break;
            }
        });

        // 初始化游戏
        function initGame() {
            initBoard();
            drawBoard();
        }

        // 页面加载初始化
        window.onload = function() {
            initGame();
            // 初始动画触发
            setTimeout(() => {
                document.querySelector('.section.active').style.opacity = '1';
                document.querySelector('.section.active').style.transform = 'translateY(0)';
            }, 100);
        };
    </script>
</body>
</html>